<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Package resolution algorithm
</title>
    <link rel="icon" type="image/png" href="./img/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="A dependency manager for .NET with support for NuGet packages and git repositories."/>
    <meta name="author" content="Steffen Forkmann, Alexander GroÃŸ"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="./content/style.css" />
    <script type="text/javascript" src="./content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style type="text/css">
      table.pre td.lines {
        vertical-align: top;
      }
      pre.fssnip code[lang=batchfile],
      pre.fssnip code[lang=msh] {
        display: inline-block;
        white-space: pre-wrap;       /* CSS 3 */
        white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
        white-space: -pre-wrap;      /* Opera 4-6 */
        white-space: -o-pre-wrap;    /* Opera 7 */
        word-wrap: break-word;       /* Internet Explorer 5.5+ */
        word-break: keep-all;
        padding-left: 2em;
        text-indent: -2em;
      }
    </style>
    <script type="text/javascript">
      $(function() {
        $("code[lang='batchfile'], code[lang='msh']").each(function() {
          $(this).html($(this).html().replace(/ &lt;/g, "&nbsp;&lt;"))
        })
      })
    </script>
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/fsprojects/Paket">github page</a></li>
        </ul>
        <h3 class="muted"><a href="./index.html">Paket</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Package-resolution-algorithm" class="anchor" href="#Package-resolution-algorithm">Package resolution algorithm</a></h1>
<h2><a name="Overview" class="anchor" href="#Overview">Overview</a></h2>
<p>Paket uses the <a href="dependencies-file.html"><code>paket.dependencies</code> file</a> to specify
project dependencies. Usually only direct dependencies are specified and often a
broad range of package versions is allowed. During
<a href="paket-install.html"><code>paket install</code></a> Paket needs to figure out concrete
versions of the specified packages and their transitive dependencies. These
versions are then persisted to the <a href="lock-file.html"><code>paket.lock</code> file</a>.</p>
<p>In order to figure out the concrete versions Paket needs to solve the following
constraint satisfaction problem:</p>
<ul>
<li>
Select the latest version for each of the packages in the
<a href="dependencies-file.html"><code>paket.dependencies</code> file</a>, plus all their transitive
dependencies, such that all version constraints are satisfied.
</li>
</ul>
<p><strong>Note:</strong></p>
<ul>
<li>
In general, more than one solution to this problem can exist and the solver
will take the first solution that it finds.
</li>
<li>
If you change the
<a href="dependencies-file.html#Resolver-strategy-for-transitive-dependencies">resolution strategy</a>
then Paket needs to find the <em>oldest matching version</em>
</li>
</ul>
<h2><a name="Getting-data" class="anchor" href="#Getting-data">Getting data</a></h2>
<p>The
<a href="http://en.wikipedia.org/wiki/Constraint_satisfaction_problem">constraint satisfaction problem</a>
is covered by many <a href="resolver.html#Further-reading">scientific papers</a>, but a big
challenge for Paket's resolver is that it doesn't have the full constraints
available. The algorithm needs to evaluate the package dependency graph along
the way by retrieving data from the <a href="nuget-dependencies.html">NuGet</a> source
feeds.</p>
<p>The two important API questions are:</p>
<ul>
<li>What versions of a package are available?</li>
<li>Given a concrete version of a package, what further dependencies are required?</li>
</ul>
<p>Answering these questions is a very expensive operation since it involves a HTTP
request and therefore the resolver has to minimize these requests and only
access the API when really needed.</p>
<h2><a name="Basic-algorithm" class="anchor" href="#Basic-algorithm">Basic algorithm</a></h2>
<p>Starting from the <a href="dependencies-file.html"><code>paket.dependencies</code> file</a> we have a
set of package requirements. Every requirement specifies a version range and a
resolver strategy for a package:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span class="i">PackageRequirementSource</span> <span class="o">=</span>
| <span class="i">DependenciesFile</span> <span class="k">of</span> <span class="i">string</span>
| <span class="i">Package</span> <span class="k">of</span> <span class="i">PackageName</span> <span class="o">*</span> <span class="i">SemVerInfo</span>

<span class="k">type</span> <span class="i">ResolverStrategy</span> <span class="o">=</span> <span class="i">Max</span> | <span class="i">Min</span>

<span class="k">type</span> <span class="i">PackageRequirement</span> <span class="o">=</span>
    { <span class="i">Name</span> <span class="o">:</span> <span class="i">PackageName</span>
      <span class="i">VersionRequirement</span> <span class="o">:</span> <span class="i">VersionRequirement</span>
      <span class="i">ResolverStrategy</span> <span class="o">:</span> <span class="i">ResolverStrategy</span>
      <span class="i">Parent</span><span class="o">:</span> <span class="i">PackageRequirementSource</span>
      <span class="i">Sources</span> <span class="o">:</span> <span class="i">PackageSource</span> <span class="i">list</span> }
</code></pre></td>
</tr>
</table>
<p>The algorithm works as a
<a href="https://en.wikipedia.org/wiki/Breadth-first_search">Breadth-first search</a>. In
every step it selects a requirement from the set of <em>open</em> requirements and
checks if the requirement can be satisfied. If no conflict arises then a package
version gets selected and all it's dependencies are added to the <em>open</em>
requirements. A set of <em>closed</em> requirements is maintained in order to prevent
cycles in the search graph.</p>
<p>If the selected requirement results in a conflict then the algorithm backtracks
in the search tree and selects the next version.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="k">rec</span> <span class="i">step</span>(<span class="i">selectedPackageVersions</span><span class="o">:</span><span class="i">Set</span><span class="o">&lt;</span><span class="i">ResolvedPackage</span><span class="o">&gt;</span>,
             <span class="i">closedRequirements</span><span class="o">:</span><span class="i">Set</span><span class="o">&lt;</span><span class="i">PackageRequirement</span><span class="o">&gt;</span>,
             <span class="i">openRequirements</span><span class="o">:</span><span class="i">Set</span><span class="o">&lt;</span><span class="i">PackageRequirement</span><span class="o">&gt;</span>) <span class="o">=</span>

    <span class="k">match</span> <span class="i">selectNextRequirement</span> <span class="i">openRequirements</span> <span class="k">with</span>
    | <span class="i">Some</span>(<span class="i">currentRequirement</span>,<span class="i">stillOpen</span>) <span class="k">-&gt;</span>
        <span class="k">let</span> <span class="i">availableVersions</span> <span class="o">=</span>
            <span class="k">match</span> <span class="i">getSelectedPackageVersion</span> <span class="i">currentRequirement</span><span class="o">.</span><span class="i">Name</span> <span class="i">selectedPackageVersions</span> <span class="k">with</span>
            | <span class="i">Some</span> <span class="i">version</span> <span class="k">-&gt;</span>
                <span class="c">// we already selected a version so we can&#39;t pick a different</span>
                [<span class="i">version</span>]
            | <span class="i">None</span> <span class="k">-&gt;</span>
                <span class="c">// we didn&#39;t select a version yet so all versions are possible</span>
                <span class="i">getAllVersionsFromNuget</span> <span class="i">currentRequirement</span><span class="o">.</span><span class="i">Name</span>

        <span class="k">let</span> <span class="i">compatibleVersions</span> <span class="o">=</span>
            <span class="c">// consider only versions, which match the current requirement</span>
            <span class="i">availableVersions</span>
            <span class="o">|&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">filter</span> (<span class="i">isInRange</span> <span class="i">currentRequirement</span><span class="o">.</span><span class="i">VersionRequirement</span>)

        <span class="k">let</span> <span class="i">sortedVersions</span> <span class="o">=</span>
            <span class="k">match</span> <span class="i">currentRequirement</span><span class="o">.</span><span class="i">ResolverStrategy</span> <span class="k">with</span>
            | <span class="i">ResolverStrategy</span><span class="o">.</span><span class="i">Max</span> <span class="k">-&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">sort</span> <span class="i">compatibleVersions</span> <span class="o">|&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">rev</span>
            | <span class="i">ResolverStrategy</span><span class="o">.</span><span class="i">Min</span> <span class="k">-&gt;</span> <span class="i">List</span><span class="o">.</span><span class="i">sort</span> <span class="i">compatibleVersions</span>

        <span class="k">let</span> <span class="k">mutable</span> <span class="i">conflictState</span> <span class="o">=</span> <span class="i">Resolution</span><span class="o">.</span><span class="i">Conflict</span>(<span class="i">stillOpen</span>)

        <span class="k">for</span> <span class="i">versionToExplore</span> <span class="k">in</span> <span class="i">sortedVersions</span> <span class="k">do</span>
            <span class="k">match</span> <span class="i">conflictState</span> <span class="k">with</span>
            | <span class="i">Resolution</span><span class="o">.</span><span class="i">Conflict</span> _ <span class="k">-&gt;</span>
                <span class="k">let</span> <span class="i">packageDetails</span> <span class="o">=</span> <span class="i">getPackageDetails</span>(<span class="i">currentRequirement</span><span class="o">.</span><span class="i">Name</span>,<span class="i">versionToExplore</span>)

                <span class="i">conflictState</span> <span class="o">&lt;-</span>
                    <span class="i">step</span>(<span class="i">Set</span><span class="o">.</span><span class="i">add</span> <span class="i">packageDetails</span> <span class="i">selectedPackageVersions</span>,
                         <span class="i">Set</span><span class="o">.</span><span class="i">add</span> <span class="i">currentRequirement</span> <span class="i">closedRequirements</span>,
                         <span class="i">addDependenciesToOpenSet</span>(<span class="i">packageDetails</span>,<span class="i">closedRequirements</span>,<span class="i">stillOpen</span>))
            | <span class="i">Resolution</span><span class="o">.</span><span class="i">Ok</span> _ <span class="k">-&gt;</span> ()

        <span class="i">conflictState</span>
    | <span class="i">None</span> <span class="k">-&gt;</span>
        <span class="c">// we are done - return the selected versions</span>
        <span class="i">Resolution</span><span class="o">.</span><span class="i">Ok</span>(<span class="i">selectedPackageVersions</span>)
</code></pre></td>
</tr>
</table>
<h3><a name="Sorting-package-requirements" class="anchor" href="#Sorting-package-requirements">Sorting package requirements</a></h3>
<p>In order to make progress in the search tree the algorithm needs to determine
the next package. Paket uses a heuristic, which tries to process packages with
small version ranges and high conflict potential first. Therefore, it orders the
requirements based on:</p>
<ul>
<li>
Is the
<a href="nuget-dependencies.html#Use-exactly-this-version-constraint">version pinned</a>?
</li>
<li>Is it a direct requirement coming from the dependencies file?</li>
<li>
Is the
<a href="dependencies-file.html#Resolver-strategy-for-transitive-dependencies">resolution strategy</a>
<code>Min</code> or <code>Max</code>?
</li>
<li>
How big is the current
<a href="resolver.html#Package-conflict-boost">package specific boost factor</a>?
</li>
<li>How big is the specified version range?</li>
<li>The package name (alphabetically) as a tie breaker.</li>
</ul>
<h3><a name="Package-conflict-boost" class="anchor" href="#Package-conflict-boost">Package conflict boost</a></h3>
<p>Whenever Paket encounters a package version conflict in the search tree it
increases a boost factor for the involved packages. This heuristic influences
the <a href="resolver.html#Sorting-package-requirements">package evaluation order</a> and
forces the resolver to deal with conflicts much earlier in the search tree.</p>
<h2><a name="Branch-and-bound" class="anchor" href="#Branch-and-bound">Branch and bound</a></h2>
<p>Every known resolution conflict is stored in a <code>HashSet</code>. At every step Paket
will always check if the current requirement set (union of <em>open</em> requirements
and <em>closed</em> requirements) is a superset of a known conflict. In this case Paket
can stop evaluating that part of the search tree.</p>
<h2><a name="Caching-and-lazy-evaluation" class="anchor" href="#Caching-and-lazy-evaluation">Caching and lazy evaluation</a></h2>
<p>Since HTTP requests to NuGet are very expensive Paket tries to reduce these
calls as much as possible:</p>
<ul>
<li>
The function <code>getAllVersionsFromNuget</code> will call the NuGet API at most once
per package and Paket run.
</li>
<li>
The function <code>getPackageDetails</code> will only call the NuGet API if package
details are not found in the RAM or on disk.
</li>
</ul>
<p>The second caching improvement means that subsequent runs of <code>paket update</code> can
get faster since package details are already stored on disk.</p>
<h2><a name="Error-reporting" class="anchor" href="#Error-reporting">Error reporting</a></h2>
<p>If the resolver can't find a valid resolution, then it needs to report an error
to the user. Since the search tree can be very large and might contain lots of
different kinds of failures, reporting a good error message is difficult. Paket
will only report the last conflict that it can't resolve and also some
information about the origin of this conflict.</p>
<p>If you need more information you can try the verbose mode by using the
<code>--verbose</code> parameter.</p>
<h2><a name="Further-reading" class="anchor" href="#Further-reading">Further reading</a></h2>
<ul>
<li>
<a href="http://journals.cambridge.org/action/displayAbstract?fromPage=online&amp;aid=83363&amp;fileId=S0956796801004051">Modular lazy search for Constraint Satisfaction Problems</a>
by T. Nordin and A. Tolmach (<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.34.4704&amp;rep=rep1&amp;type=pdf">PDF</a>)
</li>
<li>
<a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.45.2528">On The Forward Checking Algorithm</a>
by F. Bacchus and A. Grove (<a href="http://www.cs.toronto.edu/~fbacchus/Papers/BGCP95.pdf">PDF</a>)
</li>
<li>
<a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.52.6526">Structuring Depth-First Search Algorithms in Haskell</a>
by D. King and J. Launchbury (<a href="http://galois.com/wp-content/uploads/2014/08/pub_JL_StructuringDFSAlgorithms.pdf">PDF</a>)
</li>
<li>
<a href="http://www.well-typed.com/blog/2015/03/qualified-goals/">Qualified Goals in the Cabal Solver</a>
(<a href="https://vimeo.com/31846783">Video</a>)
</li>
</ul>


        </div>
        <div class="span3">
          <img src="./img/logo.png" alt="F# Project" style="width:150px;margin:10px" />
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Paket</li>
            <li><a href="./index.html">Home page</a></li>
            <li><a href="./getting-started.html">Getting started</a></li>
            <li><a href="./convert-from-nuget-tutorial.html">Convert from NuGet</a></li>
            <li><a href="./faq.html">FAQ</a></li>
            <li><a href="./glossary.html">Glossary</a></li>
            <li><a href="./release-notes.html">Release Notes</a></li>
            <li><a href="./testimonials.html">Testimonials</a></li>
            <li><a href="./license.html">License</a></li>

            <li class="nav-header">Download Paket</li>
            <li><a href="http://nuget.org/packages/Paket" target="_blank">From NuGet</a></li>
            <li><a href="https://github.com/fsprojects/Paket/releases/latest" target="_blank">From GitHub</a></li>

            <li class="nav-header">GitHub</li>
            <li><a href="http://github.com/fsprojects/Paket" target="_blank">Source Code on GitHub</a></li>
            <li><a href="http://github.com/fsprojects/Paket/issues" target="_blank">Report an issue</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="./dependencies-file.html">paket.dependencies</a></li>
            <li><a href="./lock-file.html">paket.lock</a></li>
            <li><a href="./references-files.html">paket.references</a></li>
            <li><a href="./template-files.html">paket.template</a></li>
            <li><a href="./local-file.html">paket.local</a></li>
            <li><a href="./paket-folder.html">.paket folder</a></li>
            <li><a href="./bootstrapper.html">paket.bootstrapper.exe</a></li>
            <li class="divider"></li>
            <li><a href="./resolver.html">Package resolution algorithm</a></li>
            <li><a href="./groups.html">Dependency Groups</a></li>
            <li><a href="./caches.html">Additional Caches</a></li>
            <li><a href="./nuget-dependencies.html">NuGet dependencies</a></li>
            <li><a href="./git-dependencies.html">Git dependencies</a></li>
            <li><a href="./github-dependencies.html">GitHub dependencies</a></li>
            <li><a href="./http-dependencies.html">HTTP dependencies</a></li>
            <li><a href="./analyzers.html">Analyzers</a></li>
            <li class="divider"></li>
            <li><a href="./installation.html">Installation</a></li>
            <li><a href="./paket-and-dotnet-cli.html">Using Paket with dotnet cli</a></li>
            <li><a href="./reference-from-repl.html">Using Paket from F# Interactive</a></li>
            <li><a href="./editor-support.html">Editor support</a></li>
            <li><a href="./shell-completion.html">Shell completion</a></li>
            <li class="divider"></li>
            <li><a href="./reference/index.html">API Reference</a></li>

            <li class="nav-header">Paket commands</li>
            <li><a href="./paket-add.html">paket add</a></li>
            <li><a href="./paket-auto-restore.html">paket auto-restore</a></li>
            <li><a href="./paket-clear-cache.html">paket clear-cache</a></li>
            <li><a href="./paket-config.html">paket config</a></li>
            <li><a href="./paket-convert-from-nuget.html">paket convert-from-nuget</a></li>
            <li><a href="./paket-find-refs.html">paket find-refs</a></li>
            <li><a href="./paket-find-packages.html">paket find-packages</a></li>
            <li><a href="./paket-find-package-versions.html">paket find-package-versions</a></li>
            <li><a href="./paket-generate-load-scripts.html">paket generate-load-scripts</a></li>
            <li><a href="./paket-init.html">paket init</a></li>
            <li><a href="./paket-install.html">paket install</a></li>
            <li><a href="./paket-outdated.html">paket outdated</a></li>
            <li><a href="./paket-pack.html">paket pack</a></li>
            <li><a href="./paket-push.html">paket push</a></li>
            <li><a href="./paket-remove.html">paket remove</a></li>
            <li><a href="./paket-restore.html">paket restore</a></li>
            <li><a href="./paket-simplify.html">paket simplify</a></li>
            <li><a href="./paket-show-groups.html">paket show-groups</a></li>
            <li><a href="./paket-show-installed-packages.html">paket show-installed-packages</a></li>
            <li><a href="./paket-update.html">paket update</a></li>
            <li><a href="./paket-why.html">paket why</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/fsprojects/Paket"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
</html>
